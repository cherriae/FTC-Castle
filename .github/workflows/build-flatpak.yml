name: Build Flatpak

on:
  push:
    branches: [ deploy ]
  pull_request:
    branches: [ deploy ]
  workflow_dispatch:
    
permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  discussions: write
  id-token: write
  issues: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write


jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgirepository1.0-dev libgirepository-2.0-dev libcairo2-dev pkg-config python3-dev
        # Install WebKit dependencies for Ubuntu 24.04
        sudo apt-get install -y gir1.2-webkit2-4.1 libwebkit2gtk-4.1-dev
        # Install system PyGobject
        sudo apt-get install -y python3-gi python3-gi-cairo
        # Install GLib dev (needed for GTK applications)
        sudo apt-get install -y libglib2.0-dev desktop-file-utils
        # Install Flatpak tooling
        sudo apt-get install -y flatpak flatpak-builder gnome-software-plugin-flatpak
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.3'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install briefcase
    
    - name: Create Flatpak package
      working-directory: ./standalone
      run: |
        python -m briefcase create linux flatpak --no-input -vv
        python -m briefcase build linux flatpak --no-input --update-resources -vv
        python -m briefcase package linux flatpak --no-input -vv
    
    - name: Upload Flatpak bundle
      uses: actions/upload-artifact@v4
      with:
        name: castle-flatpak-bundle
        path: standalone/dist/Castle-*.flatpak
        if-no-files-found: warn
    
    - name: Upload build log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-build-logs
        path: ./standalone/logs/ 